# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

### Core Development
```bash
npm run dev          # Start development server with Turbopack
npm run build        # Build for production
npm run start        # Start production server
npm run lint         # Run Next.js linting
```

### Common Development Tasks
```bash
# Database operations
npx prisma generate  # Generate Prisma client
npx prisma db push   # Push schema changes
npx prisma studio    # Open Prisma studio

# Run single test (if tests exist)
npm test -- --testNamePattern="test name"
```

## Architecture Overview

### Technology Stack
- **Frontend**: Next.js 15 with App Router, React 18, TypeScript
- **Styling**: Tailwind CSS with Framer Motion animations
- **Database**: Dual architecture - Prisma (PostgreSQL) + Supabase
- **Authentication**: Supabase Auth with custom cookie management
- **Payments**: Stripe integration with webhook handling
- **Calendar**: Cal.com embed integration
- **AI Integration**: OpenRouter API with Google Gemini 1.5 Flash 8B for Agent Assistant

### Project Structure
```
src/
├── app/                    # Next.js App Router
│   ├── api/               # API routes (auth, subscriptions, transcriptions)
│   ├── dashboard/         # Protected dashboard area
│   ├── mobile/            # Mobile-optimized interfaces
│   └── (auth)/           # Authentication pages
├── components/            # Reusable React components
│   ├── auth/             # Authentication forms
│   ├── calendar/         # Cal.com integration
│   ├── settings/         # User settings and preferences
│   └── mobile/           # Mobile-specific components
├── lib/                  # Utility libraries
│   ├── db.ts            # Prisma client configuration
│   ├── supabase.ts      # Supabase client setup
│   └── stripe.ts        # Stripe integration
└── middleware.ts         # Route protection and auth
```

### Key Architectural Patterns

#### Authentication Flow
- Custom cookie-based authentication using Supabase Auth
- Route protection via middleware (`/src/middleware.ts`)
- Authentication state managed via `useUser` hook (`/src/lib/hooks/useUser.ts`)
- Protected routes redirect to `/login` if unauthenticated

#### Data Management
- **Dual Database**: Prisma for user/subscription data, Supabase for voicemail transcriptions
- **API Layer**: RESTful endpoints in `/src/app/api/`
- **Real-time Features**: Supabase subscriptions for voicemail updates

#### Subscription Management
- Stripe integration for payment processing
- Webhook handling at `/api/webhook/stripe/route.ts`
- Tiered plans: Basic, Pro, Enterprise
- Dev endpoints for testing subscription flows

### Mobile-First Design
- Dedicated mobile interfaces (`/mobile/`, `/mobile-v2/`)
- Gesture-based interactions with Framer Motion
- Progressive enhancement for desktop users
- Responsive design with Tailwind CSS

### Important Configuration Files
- `prisma/schema.prisma` - Database schema
- `src/lib/db.ts` - Prisma client
- `src/lib/supabase.ts` - Supabase configuration
- `src/middleware.ts` - Route protection
- `MOBILE_UX_DESIGN.md` - Mobile interface specifications

### API Routes Structure
```
/api/
├── agent/chat/         # AI agent chat endpoint (OpenRouter/Gemini)
├── checkout/           # Stripe checkout sessions
├── subscriptions/      # Subscription management
├── transcriptions/     # Voicemail transcription handling
├── user/profile/       # User profile management
└── webhook/stripe/     # Stripe webhook processing
```

### Development Notes
- Uses Turbopack for faster development builds
- Environment variables required for Supabase, Stripe, and OpenRouter
- Custom authentication middleware protects dashboard routes
- Mobile interfaces use gesture-based interactions
- Comprehensive dev API endpoints for testing
- AI integration requires OpenRouter API key for production deployment

### Testing
- No specific test framework configured in package.json
- Manual testing via dev API endpoints
- Stripe testing via webhook test endpoints

## Mobile Interface Specifications

The mobile interface follows a gesture-first design optimized for ZZP'ers (Dutch independent contractors) with business productivity features. Key features include:

- **Gesture Calendar**: Swipe-based time slot management
- **Voicemail Management**: Swipe actions for archive/delete
- **Agent Assistant**: AI-powered business assistant with real-time chat
- **Action Management**: Swipeable action cards generated by AI agent
- **Voice Interface**: Touch-and-hold voice recording for hands-free operation
- **Onboarding Flow**: Personalized setup wizard

### Agent Assistant Feature
The Agent Assistant (/mobile-v3/agent) provides:
- **Real-time AI Chat**: Powered by Google Gemini 1.5 Flash 8B via OpenRouter
- **Business Context**: AI understands user's services, pricing, and recent conversations
- **Action Generation**: AI creates concrete tasks (callbacks, emails, quotes, meetings)
- **Gesture Controls**: Swipe right to approve, left to reject AI-generated actions
- **Voice Input**: Press-and-hold microphone for voice commands
- **Quick Commands**: Pre-defined business actions for common tasks
- **Mobile-First UX**: Optimized for one-handed operation while on-the-go

Refer to `MOBILE_UX_DESIGN.md` for detailed mobile interface specifications and implementation guidelines.

## Environment Variables

For successful deployment to Vercel, ensure these environment variables are configured:

### Required for Production
```bash
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key

# AI Configuration (Required for Agent Assistant)
OPEN_ROUTER_API=your_openrouter_api_key

# Stripe Configuration
STRIPE_SECRET_KEY=your_stripe_secret_key
STRIPE_WEBHOOK_SECRET=your_stripe_webhook_secret
STRIPE_PRICE_BASIC_MONTHLY=price_id
STRIPE_PRICE_PRO_MONTHLY=price_id
STRIPE_PRICE_ENTERPRISE_MONTHLY=price_id
STRIPE_PRICE_BASIC_YEARLY=price_id
STRIPE_PRICE_PRO_YEARLY=price_id
STRIPE_PRICE_ENTERPRISE_YEARLY=price_id

# App Configuration
NEXT_PUBLIC_DOMAIN=your_domain.com
NEXT_PUBLIC_FORWARDING_NUMBER=your_phone_number
NEXT_PUBLIC_DEV_BYPASS_STRIPE=false  # Set to false in production

# Database Configuration
DATABASE_URL=your_database_url
```

### Dependencies
Ensure package.json includes:
- `openai`: ^5.9.0 (for OpenRouter API integration)
- `framer-motion`: ^11.0.0 (for gesture controls)
- All other existing dependencies

### Deployment Notes
- Agent Assistant requires OPEN_ROUTER_API key to function
- Without API key, Agent will show fallback responses
- All gestures and UI work without API key, but no real AI responses
- OpenRouter supports Google Gemini 1.5 Flash 8B model for cost-effective AI responses